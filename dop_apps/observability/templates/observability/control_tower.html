{% extends "observability/base.html" %}
{% block content %}

<section class="card">
  <div class="ct-header">
    <div class="ct-header-left">
      <div class="ct-title-row">
        <strong class="ct-title">DATA OBSERVABILITY PLATFORM — MONITORING DASHBOARD</strong>
        <button
          type="button"
          class="info-btn"
          id="statusInfoBtn"
          aria-label="Show status and KPI definitions"
          aria-haspopup="dialog"
          aria-controls="statusModal"
          title="Definitions"
        >i</button>
      </div>

      <div class="ct-meta">
        <span>Status:</span>

        <span
          class="status-dot"
          style="background-color: {{ status.dot_color }};"
        ></span>

        <strong>{{ status.status|default:"—" }}</strong>

        <span class="ct-sep">|</span>

        <span>Last ingest:</span>
        <strong>{{ status.last_ingest|default:"—" }} (UTC)</strong>
      </div>
    </div>
  </div>
</section>


<div class="grid grid-1">

  <section class="card">
    <h3 class="card-title">
      PIPELINE HEALTH
      <button
        type="button"
        class="info-btn"
        id="pipelineInfoBtn"
        aria-label="Show pipeline job definitions"
        aria-haspopup="dialog"
        aria-controls="pipelineModal"
        title="Definitions"
      >i</button>
    </h3>

    <div class="table-wrap">
      <table class="table">
        <colgroup>
          <col style="width:55%;">
          <col style="width:20%;">
          <col style="width:25%;">
        </colgroup>

        <tr>
          <th>Job</th>
          <th>Status</th>
          <th>Last Run (UTC)</th>
        </tr>

        {% for r in pipeline %}
        <tr>
          <td>{{ r.job_name }}</td>
          <td>{{ r.last_status }}</td>
          <td class="nowrap">{{ r.last_run_at|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">—</td></tr>
        {% endfor %}
      </table>
    </div>
  </section>

  <section class="card">
    <h3 class="card-title">
      DATA QUALITY
      <button
        type="button"
        class="info-btn"
        id="dqInfoBtn"
        aria-label="Show data quality check definitions"
        aria-haspopup="dialog"
        aria-controls="dqModal"
        title="Definitions"
      >i</button>
    </h3>

    <div class="table-wrap">
      <table class="table">
        <colgroup>
          <col style="width:55%;">
          <col style="width:20%;">
          <col style="width:25%;">
        </colgroup>

        <tr>
          <th>Check</th>
          <th>Status</th>
          <th>Last Run (UTC)</th>
        </tr>

        {% for r in dq %}
        <tr>
          <td>{{ r.check_name }}</td>
          <td>{{ r.status }}</td>
          <td class="nowrap">{{ r.last_run_at|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">—</td></tr>
        {% endfor %}
      </table>
    </div>
  </section>

</div>


<div class="grid grid-2">

  <section class="card">
    <h3 class="card-title">
      ANOMALIES
      <button
        type="button"
        class="info-btn"
        id="anomalyInfoBtn"
        aria-label="Show anomaly definitions"
        aria-haspopup="dialog"
        aria-controls="anomalyModal"
        title="Definitions"
      >i</button>
    </h3>

    <div class="table-wrap">
      <table class="table">
        <tr>
          <th>Anomaly</th>
          <th>Count (24h)</th>
        </tr>
        {% for r in anomalies %}
        <tr>
          <td>{{ r.anomaly_type }}</td>
          <td>{{ r.anomalies_24h }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">—</td></tr>
        {% endfor %}
      </table>
    </div>
  </section>

  <section class="card">
    <h3 class="card-title">INCIDENTS</h3>
    <div class="kv">Open: <strong>{{ incidents.open_count }}</strong></div>
    <div class="kv">Acknowledged: <strong>{{ incidents.acknowledged_count }}</strong></div>
    <div class="kv">Resolved (total): <strong>{{ incidents.resolved_count_total }}</strong></div>
    <div class="kv">Resolved (24h): <strong>{{ incidents.resolved_count_24h }}</strong></div>
  </section>

</div>

<!-- Modals ... unchanged -->
<!-- =========================
     Modals
     ========================= -->

<!-- ANOMALY -->
<div class="modal-backdrop" id="anomalyBackdrop" aria-hidden="true"></div>
<div class="modal" id="anomalyModal" role="dialog" aria-modal="true" aria-labelledby="anomalyModalTitle" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4 class="modal-title" id="anomalyModalTitle">Anomaly definitions</h4>
      <button type="button" class="modal-close" id="anomalyCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="defs">
      <div class="def-item"><p class="def-key">drop</p><p class="def-desc">Sudden downward drop in a metric relative to recent baseline.</p></div>
      <div class="def-item"><p class="def-key">flatline</p><p class="def-desc">Metric values stop changing over an extended window (possible sensor failure).</p></div>
      <div class="def-item"><p class="def-key">silent_station</p><p class="def-desc">Station stopped reporting any observations for one or more metrics.</p></div>
      <div class="def-item"><p class="def-key">spike</p><p class="def-desc">Sudden upward jump in a metric relative to recent baseline.</p></div>
      <div class="def-item"><p class="def-key">stale_data</p><p class="def-desc">Observations continue but observed_at does not advance (stuck timestamps).</p></div>
    </div>
  </div>
</div>

<!-- PIPELINE -->
<div class="modal-backdrop" id="pipelineBackdrop" aria-hidden="true"></div>
<div class="modal" id="pipelineModal" role="dialog" aria-modal="true" aria-labelledby="pipelineModalTitle" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4 class="modal-title" id="pipelineModalTitle">Pipeline job definitions</h4>
      <button type="button" class="modal-close" id="pipelineCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="defs">
      <div class="def-item">
        <p class="def-key">ingest_openmeteo_all_stations</p>
        <p class="def-desc">Collects fresh weather data from all monitored stations and stores it exactly as received.</p>
      </div>
      <div class="def-item">
        <p class="def-key">transform_raw_to_fact</p>
        <p class="def-desc">Cleans/standardizes raw data, converts units, validates values, prepares for dashboards.</p>
      </div>
      <div class="def-item">
        <p class="def-key">dq_check_run</p>
        <p class="def-desc">Runs data quality checks to catch missing/stale/inconsistent data.</p>
      </div>
      <div class="def-item">
        <p class="def-key">anomaly_detection</p>
        <p class="def-desc">Detects spikes/drops/flatlines/silent stations and may open incidents.</p>
      </div>
    </div>
  </div>
</div>

<!-- DATA QUALITY -->
<div class="modal-backdrop" id="dqBackdrop" aria-hidden="true"></div>
<div class="modal" id="dqModal" role="dialog" aria-modal="true" aria-labelledby="dqModalTitle" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4 class="modal-title" id="dqModalTitle">Data quality checks</h4>
      <button type="button" class="modal-close" id="dqCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="defs">
      <div class="def-item"><p class="def-key">fact_freshness_minutes</p><p class="def-desc">How recently data was observed per station/metric.</p></div>
      <div class="def-item"><p class="def-key">metric_completeness_pct</p><p class="def-desc">Whether all expected metrics exist at the latest time.</p></div>
      <div class="def-item"><p class="def-key">late_data_rate_pct</p><p class="def-desc">Share of observations arriving later than allowed.</p></div>
      <div class="def-item"><p class="def-key">late_data_rate_pct_all_time</p><p class="def-desc">Long-term late-arrival rate.</p></div>
      <div class="def-item"><p class="def-key">raw_duplicate_key_count</p><p class="def-desc">Duplicate raw ingestion keys (replay/duplication).</p></div>
      <div class="def-item"><p class="def-key">fact_duplicate_key_count</p><p class="def-desc">Duplicate fact-table keys (dedupe/transform issue).</p></div>
      <div class="def-item"><p class="def-key">stations_missing_any_metric_count_latest_hour</p><p class="def-desc">Stations missing one+ expected metrics in the latest window.</p></div>
      <div class="def-item"><p class="def-key">value_out_of_range_count</p><p class="def-desc">Values outside expected ranges (sensor/corruption).</p></div>
    </div>
  </div>
</div>

<!-- STATUS -->
<div class="modal-backdrop" id="statusBackdrop" aria-hidden="true"></div>
<div class="modal" id="statusModal" role="dialog" aria-modal="true" aria-labelledby="statusModalTitle" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4 class="modal-title" id="statusModalTitle">Status</h4>
      <button type="button" class="modal-close" id="statusCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="defs">
      <div class="def-item">
        <p class="def-key">Status (GREEN / AMBER / RED)</p>
        <p class="def-desc">
          Overall platform health computed by <code>vw_platform_status</code>.
          RED = open incidents. AMBER = DQ fail in last 24h or freshness &gt; 120. GREEN = none.
        </p>
      </div>
    </div>
  </div>
</div>


{% endblock %}
